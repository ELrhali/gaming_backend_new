{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}Importation des Images de Produits{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-images me-2"></i>Importation des Images de Produits
                    </h5>
                    <div>
                   
                        <a href="{% url 'admin_panel:product_list' %}" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Retour aux produits
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Afficher les messages -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="white-space: pre-line;">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <!-- Statistiques -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-primary">{{ stats.products }}</h3>
                                    <p class="text-muted mb-0">Total Produits</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-success">{{ stats.products_with_images }}</h3>
                                    <p class="text-muted mb-0">Produits avec Images</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h3 class="text-info">{{ stats.total_images }}</h3>
                                    <p class="text-muted mb-0">Total Images</p>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Instructions d√©taill√©es -->
                    <div class="alert alert-info alert-permanent">
                        <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>üìã Guide d'importation des images - √âtape par √©tape</h5>
                        <hr>
                        
                        <!-- √âtape 0: Pr√©requis -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-download me-1"></i> √âtape 0 : Pr√©parer votre travail</h6>
                            <ol class="mb-2">
                                <li>Ce fichier contient la <strong>R√©f√©rence</strong> et le <strong>Nom</strong> de chaque produit dans la base de donn√©es</li>
                                <li>Utilisez ces informations pour cr√©er vos dossiers d'images</li>
                            </ol>
                        </div>

                        <!-- Sp√©cifications images -->
                        <div class="alert alert-warning alert-permanent py-2 mb-4">
                            <h6 class="mb-2"><i class="fas fa-camera me-1"></i> Sp√©cifications des images</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <small>
                                        <strong>üìê Dimension recommand√©e:</strong> 600 x 600 px (carr√© 1:1)<br>
                                        <strong>üìÅ Format:</strong> WebP ou JPG recommand√© (PNG, GIF aussi accept√©s)
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <small>
                                        <strong>üìä Taille max:</strong> 100 KB par image<br>
                                        <strong>üé® Conseil:</strong> Fond blanc pr√©f√©r√© pour un meilleur rendu
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- √âtape 1: Structure du dossier -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-folder me-1"></i> √âtape 1 : Cr√©er la structure des dossiers</h6>
                            <p class="mb-2">Organisez vos images dans une structure de dossiers comme suit :</p>
                            
                            <div class="bg-dark text-light p-3 rounded mb-3" style="font-family: monospace; font-size: 0.9rem;">
                                <div><i class="fas fa-folder text-warning"></i> <strong>Dossier Principal</strong> (ex: Produits Mustang)</div>
                                <div class="ms-4"><i class="fas fa-folder text-info"></i> Nom du Produit 1</div>
                                <div class="ms-5"><i class="fas fa-folder text-success"></i> <strong>BT000050</strong> (R√©f√©rence du produit)</div>
                                <div class="ms-5 text-muted">‚îÇ</div>
                                <div class="ms-5"><i class="fas fa-folder text-danger"></i> <strong>Image</strong> ‚Üí Contient l'image principale</div>
                                <div class="ms-5 text-muted">‚îÇ   ‚îî‚îÄ‚îÄ photo_principale.webp</div>
                                <div class="ms-5"><i class="fas fa-folder text-danger"></i> <strong>Menu</strong> ‚Üí Contient les images suppl√©mentaires</div>
                                <div class="ms-5 text-muted">    ‚îî‚îÄ‚îÄ photo_2.webp, photo_3.webp, ...</div>
                                <div class="ms-4"><i class="fas fa-folder text-info"></i> Nom du Produit 2</div>
                                <div class="ms-5"><i class="fas fa-folder text-success"></i> <strong>PC000123</strong> (R√©f√©rence)</div>
                                <div class="ms-5 text-muted">‚îÇ</div>
                                <div class="ms-5"><i class="fas fa-folder text-danger"></i> Image</div>
                                <div class="ms-5"><i class="fas fa-folder text-danger"></i> Menu</div>
                                <div class="ms-4">...</div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Captures d'√©cran √©tape par √©tape -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-images me-1"></i> √âtape 2 : Visualisation de la structure (Captures d'√©cran)</h6>
                            
                            <div class="row">
                                <!-- Capture 1: Dossier principal -->
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100 border-primary">
                                        <div class="card-header bg-primary text-white py-2">
                                            <small><strong>üìÅ 1. Dossier Principal</strong></small>
                                        </div>
                                        <div class="card-body p-2 text-center">
                                            <img src="/media/dossier_principale.png" alt="Dossier principal" class="img-fluid rounded border" style="max-height: 200px; cursor: pointer;" onclick="openImageModal(this.src, 'Dossier Principal - Contient les sous-dossiers pour chaque produit')">
                                            <p class="small text-muted mt-2 mb-0">
                                                <i class="fas fa-info-circle"></i> Le dossier principal contient un sous-dossier pour <strong>chaque produit</strong> (nomm√© avec le nom du produit)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Capture 2: Dossier produit -->
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100 border-info">
                                        <div class="card-header bg-info text-white py-2">
                                            <small><strong>üìÇ 2. Dans le dossier produit</strong></small>
                                        </div>
                                        <div class="card-body p-2 text-center">
                                            <img src="/media/entre_dans_nom_dossier.png" alt="Dossier produit" class="img-fluid rounded border" style="max-height: 200px; cursor: pointer;" onclick="openImageModal(this.src, 'Dossier Produit - Contient le sous-dossier de r√©f√©rence')">
                                            <p class="small text-muted mt-2 mb-0">
                                                <i class="fas fa-info-circle"></i> √Ä l'int√©rieur, on trouve un dossier nomm√© avec la <strong>r√©f√©rence du produit</strong> (ex: BT000050)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Capture 3: Dossier r√©f√©rence -->
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100 border-success">
                                        <div class="card-header bg-success text-white py-2">
                                            <small><strong>üñºÔ∏è 3. Dans le dossier r√©f√©rence</strong></small>
                                        </div>
                                        <div class="card-body p-2 text-center">
                                            <img src="/media/entre_dans_reference.png" alt="Dossier r√©f√©rence" class="img-fluid rounded border" style="max-height: 200px; cursor: pointer;" onclick="openImageModal(this.src, 'Dossier R√©f√©rence - Contient les dossiers Image et Menu')">
                                            <p class="small text-muted mt-2 mb-0">
                                                <i class="fas fa-info-circle"></i> On trouve deux dossiers: <strong>Image</strong> (photo principale) et <strong>Menu</strong> (photos suppl√©mentaires)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- √âtape 3: Comprendre les dossiers -->
                        <div class="mb-4">
                            <h6 class="text-primary"><i class="fas fa-lightbulb me-1"></i> √âtape 3 : Comprendre les dossiers Image et Menu</h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-danger mb-3">
                                        <div class="card-header bg-danger text-white py-2">
                                            <i class="fas fa-star me-1"></i> Dossier <strong>Image</strong>
                                        </div>
                                        <div class="card-body py-2">
                                            <ul class="mb-0 small">
                                                <li>Contient <strong>l'image principale</strong> du produit</li>
                                                <li>C'est la premi√®re image affich√©e sur la fiche produit</li>
                                                <li>Une seule image sera prise (la premi√®re par ordre alphab√©tique)</li>
                                                <li>Utilis√©e comme vignette dans les listes de produits</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-warning mb-3">
                                        <div class="card-header bg-warning text-dark py-2">
                                            <i class="fas fa-images me-1"></i> Dossier <strong>Menu</strong>
                                        </div>
                                        <div class="card-body py-2">
                                            <ul class="mb-0 small">
                                                <li>Contient les <strong>images suppl√©mentaires</strong> (galerie)</li>
                                                <li>Ces images s'affichent dans le carrousel de la fiche produit</li>
                                                <li>Toutes les images du dossier seront import√©es</li>
                                                <li>Montrez diff√©rents angles, d√©tails, accessoires...</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- √âtape 4: Lancer l'import -->
                        <div class="mb-3">
                            <h6 class="text-primary"><i class="fas fa-play me-1"></i> √âtape 4 : Lancer l'importation</h6>
                            <ol class="mb-0">
                                <li>Copiez le chemin complet de votre <strong>dossier principal</strong></li>
                                <li>Collez-le dans le champ ci-dessous</li>
                                <li>Cliquez sur <strong>"D√©marrer l'importation"</strong></li>
                                <li>Consultez les logs pour voir le r√©sultat de chaque produit</li>
                            </ol>
                        </div>
                        
                        <hr>
                        
                        <p class="mb-0"><small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>Astuce :</strong> La recherche des produits utilise la <strong>r√©f√©rence</strong> du sous-dossier (ex: BT000050) pour trouver le produit correspondant dans la base de donn√©es. Assurez-vous que les r√©f√©rences correspondent exactement.
                        </small></p>
                    </div>

                    <!-- Formulaire d'importation -->
                    <form method="post" id="importForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="images" class="form-label">
                                <i class="fas fa-folder-open me-1"></i>S√©lectionner les images ou un dossier
                            </label>
                            <input type="file" class="form-control form-control-lg" id="images" name="images" multiple webkitdirectory directory required>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>S√©lectionnez un dossier ou plusieurs images √† importer. La structure des dossiers sera conserv√©e.
                            </small>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary btn-lg" id="importBtn">
                                <i class="fas fa-upload me-2"></i>D√©marrer l'importation
                            </button>
                        </div>
                    </form>

                    <!-- Logs d√©taill√©s (si disponibles) -->
                    {% if import_logs %}
                    <div class="mt-4">
                        <div class="card">
                            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>Logs d'importation d√©taill√©s
                                </h6>
                                <span class="badge bg-light text-dark">{{ import_logs|length }} entr√©es</span>
                            </div>
                            <div class="card-body p-0">
                                <div style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;" class="p-3">
                                    {% for log in import_logs %}
                                        <div class="mb-1 {% if '[OK]' in log %}text-success{% elif '[ERREUR]' in log %}text-danger{% elif '[ATTENTION]' in log %}text-warning{% else %}text-muted{% endif %}">
                                            {{ log }}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour agrandir les images -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" id="modalImage" class="img-fluid rounded" alt="Image agrandie">
            </div>
        </div>
    </div>
</div>

<style>
    .alert {
        border-radius: 0.5rem;
    }
    
    .card {
        border-radius: 0.5rem;
    }
    
    code {
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
    }
    
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .alert-permanent {
        /* Ne pas permettre la fermeture */
    }
    
    .card-body img {
        transition: transform 0.2s;
    }
    
    .card-body img:hover {
        transform: scale(1.05);
    }
    
    /* Style pour les logs color√©s */
    .text-success { color: #198754 !important; }
    .text-danger { color: #dc3545 !important; }
    .text-warning { color: #856404 !important; }
</style>

<script>
document.getElementById('importForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('importBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Importation en cours...';
});

function openImageModal(src, title) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModalTitle').textContent = title;
    var modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
}
</script>
{% endblock %}