{% extends 'admin_panel/base.html' %}

{% block title %}Types{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0"><i class="bi bi-tags me-2"></i>Types</h2>
    <a href="{% url 'admin_panel:type_add' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>Ajouter
    </a>
</div>

<!-- Filtres -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="search" class="form-label">Rechercher</label>
                <input type="text" 
                       class="form-control" 
                       id="search" 
                       name="search" 
                       placeholder="Nom ou description..."
                       value="{{ search }}">
            </div>
            <div class="col-md-2">
                <label for="brand" class="form-label">Marque</label>
                <select class="form-select" id="brand" name="brand">
                    <option value="">Toutes</option>
                    {% for b in brands %}
                        <option value="{{ b.id }}" {% if brand_id == b.id|stringformat:"s" %}selected{% endif %}>
                            {{ b.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="category" class="form-label">Catégorie</label>
                <select class="form-select" id="category" name="category">
                    <option value="">Toutes</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if category_id == cat.id|stringformat:"s" %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="subcategory" class="form-label">Sous-catégorie</label>
                <select class="form-select" id="subcategory" name="subcategory">
                    <option value="">Toutes</option>
                    {% for subcat in subcategories %}
                        <option value="{{ subcat.id }}" {% if subcategory_id == subcat.id|stringformat:"s" %}selected{% endif %}>
                            {{ subcat.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="status" class="form-label">Statut</label>
                <select class="form-select" id="status" name="status">
                    <option value="">Tous</option>
                    <option value="active" {% if status == 'active' %}selected{% endif %}>Actif</option>
                    <option value="inactive" {% if status == 'inactive' %}selected{% endif %}>Inactif</option>
                </select>
            </div>
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-filter me-1"></i>Filtrer
                </button>
                <a href="{% url 'admin_panel:type_list' %}" class="btn btn-secondary">
                    <i class="bi bi-x-circle me-1"></i>Réinitialiser
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Marque</th>
                        <th>Sous-catégorie</th>
                        <th>Catégorie</th>
                        <th>Ordre</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for type in types %}
                    <tr>
                        <td><strong>{{ type.name }}</strong></td>
                        <td>
                            {% if type.brand %}
                                {{ type.brand.name }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ type.subcategory.name }}</td>
                        <td>{{ type.subcategory.category.name }}</td>
                        <td>{{ type.order }}</td>
                        <td>
                            {% if type.is_active %}
                                <span class="badge bg-success">Actif</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactif</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'admin_panel:type_edit' type.pk %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{% url 'admin_panel:type_delete' type.pk %}" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center">Aucun type</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Filtrer les sous-catégories selon la catégorie sélectionnée
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('category');
    const subcategorySelect = document.getElementById('subcategory');
    
    if (categorySelect && subcategorySelect) {
        // Sauvegarder toutes les options de sous-catégories
        const allSubcategories = Array.from(subcategorySelect.options).slice(1); // Exclure "Toutes"
        
        categorySelect.addEventListener('change', function() {
            const selectedCategoryId = this.value;
            
            // Réinitialiser les sous-catégories
            subcategorySelect.innerHTML = '<option value="">Toutes</option>';
            
            if (!selectedCategoryId) {
                // Si aucune catégorie sélectionnée, afficher toutes les sous-catégories
                allSubcategories.forEach(option => {
                    subcategorySelect.appendChild(option.cloneNode(true));
                });
            } else {
                // Filtrer par AJAX pour obtenir les sous-catégories de cette catégorie
                fetch(`/admin-panel/subcategories/?category=${selectedCategoryId}`)
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const subcats = doc.querySelectorAll('table tbody tr');
                        
                        const subcatIds = new Set();
                        subcats.forEach(row => {
                            const cells = row.querySelectorAll('td');
                            if (cells.length > 0) {
                                // Extraire l'ID de la sous-catégorie depuis le lien
                                const editLink = row.querySelector('a[href*="subcategory"]');
                                if (editLink) {
                                    const match = editLink.href.match(/subcategories\/(\d+)\//);
                                    if (match) subcatIds.add(match[1]);
                                }
                            }
                        });
                        
                        // Afficher seulement les sous-catégories correspondantes
                        allSubcategories.forEach(option => {
                            if (subcatIds.has(option.value)) {
                                subcategorySelect.appendChild(option.cloneNode(true));
                            }
                        });
                    });
            }
        });
    }
});
</script>

<div class="mt-3">
    <p class="text-muted">
        <i class="bi bi-info-circle me-1"></i>
        <strong>{{ types.count }}</strong> type(s) trouvé(s)
    </p>
</div>
{% endblock %}
